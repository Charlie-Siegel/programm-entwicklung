<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Ideenbank</title>
  <style>
    body { font-family: sans-serif; background: #f6faff; margin: 0; }
    #wrapper { max-width: 1000px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 14px #0002; padding: 32px; }
    h2 { color: #0287c2; }
    table { width: 100%; border-collapse: collapse; margin-bottom: 24px; }
    th, td { border: 1px solid #e0e5ee; padding: 7px 10px; }
    th { background: #e6f2ff; }
    .btn { background: #e6f2ff; color: #0287c2; border: none; border-radius: 5px; padding: 5px 12px; cursor: pointer;}
    .btn:hover { background: #c8e4fa; }
    #formDiv { margin-bottom: 18px; }
    .small { font-size: 0.97em; color: #888;}
    #exportBtn, #importBtn { margin-right: 12px; }
    .add-btn { font-size: 1.1em; padding: 2px 7px; margin-left: 2px;}
    .catstat-row { display:flex; align-items:center; gap:6px; margin-bottom: 8px;}
    .catstat-row span { flex: 1 1 0;}
    .catstat-head { color:#026199; font-weight:bold; margin:12px 0 4px 0; display:block;}
    .dialog {
      display:none; position:fixed; top:9vh; left:0; right:0; margin:auto; width:390px;
      background:#fff; border-radius:11px; box-shadow:0 8px 36px #0005; z-index:99;
      padding:0 0 20px 0; text-align:left;
      animation: popupIn .2s;
    }
    .dialog-title {
      font-weight:bold; color:#0287c2; padding:17px 24px 11px 24px;
      font-size:1.15em; border-bottom:1px solid #eef1f4; display:flex; align-items:center; justify-content:space-between;
    }
    .dialog-content { padding:16px 24px 2px 24px; }
    .dialog-actions { padding:12px 24px 2px 24px;}
    .close-x { color:#888; background:none; border:none; font-size:1.3em; cursor:pointer; font-weight:bold;}
    .close-x:hover { color:#c00;}
    .import-vorschau-table td, .import-vorschau-table th { font-size:0.98em; }
    #fixedclock { position:fixed; right:24px; bottom:12px; background:#e8eafc; color:#048; padding:4px 16px 4px 14px; border-radius:15px 17px; box-shadow:0 2px 8px #aaa2; font-size:1.04em; z-index:10; }
    @keyframes popupIn { from {transform:scale(0.94); opacity:0.1;} to{transform:scale(1);opacity:1;}}
  </style>
</head>
<body>
  <div id="wrapper">
    <h2>Ideenbank</h2>
    <div id="formDiv">
      <input id="titel" placeholder="Titel" style="width:140px;">
      <select id="kategorie" style="width:130px;"></select>
      <button class="btn add-btn" onclick="showKategorieVerwaltung()" title="Kategorien verwalten">‚öôÔ∏è</button>
      <select id="status" style="width:130px;"></select>
      <button class="btn add-btn" onclick="showStatusVerwaltung()" title="Status verwalten">‚öôÔ∏è</button>
      <input id="datum" type="date" style="width:120px;">
      <input id="beschreibung" placeholder="Beschreibung" style="width:230px;">
      <button class="btn" onclick="addIdee()">‚ûï Hinzuf√ºgen</button>
    </div>
    <div style="margin-bottom:12px;">
      <button class="btn" id="exportBtn" onclick="exportIdeen()">‚§ì Exportieren</button>
      <button class="btn" id="importBtn" onclick="document.getElementById('importFile').click()">‚§í Importieren</button>
      <input type="file" id="importFile" accept=".json" style="display:none">
      <span style="float:right" class="small" id="autosaveMsg"></span>
    </div>
    <table id="ideenTabelle">
      <thead>
        <tr>
          <th>Titel</th><th>Kategorie</th><th>Status</th><th>Datum</th><th>Beschreibung</th><th></th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <div class="small">Status/Kategorien k√∂nnen √ºber ‚öôÔ∏è verwaltet werden. Exportiert wird im 5GL-Format.<br>
      <b>Tipp:</b> Beim Import gibt es jetzt eine Vorschau!
    </div>
  </div>
  <div id="fixedclock"></div>
  <!-- Kategorien/Status Dialog -->
  <div class="dialog" id="catstatDialog">
    <div class="dialog-title">
      <span id="catstatTitle"></span>
      <button class="close-x" onclick="closeCatstat()" title="Schlie√üen">√ó</button>
    </div>
    <div class="dialog-content" id="catstatList"></div>
    <div class="dialog-actions">
      <input id="catstatInput" style="width:62%;">
      <button class="btn" onclick="catstatAdd()">+</button>
      <button class="btn" onclick="closeCatstat()">Schlie√üen</button>
    </div>
  </div>
  <!-- Import-Preview Dialog -->
  <div class="dialog" id="importDialog">
    <div class="dialog-title">
      <span>Import-Vorschau</span>
      <button class="close-x" onclick="closeImportDialog()" title="Abbrechen">√ó</button>
    </div>
    <div class="dialog-content">
      <div id="importTableBox"></div>
    </div>
    <div class="dialog-actions">
      <button class="btn" onclick="importUebernehmen()">Alle √ºbernehmen</button>
      <button class="btn" onclick="closeImportDialog()">Abbrechen</button>
    </div>
  </div>
  <script>
    let ideen = [];
    let kategorien = ["Tool", "Export", "Organisation"];
    let stati = ["offen", "in Arbeit", "erledigt", "wichtig"];
    let importVorschauIdeen = [];

    // --- Uhrzeit/Datum anzeigen ---
    function showFixedClock() {
      let d = new Date();
      let dt = d.toLocaleDateString('de-DE', {weekday:'short', year:'numeric', month:'2-digit', day:'2-digit'});
      let t = d.toLocaleTimeString('de-DE', {hour:'2-digit', minute:'2-digit'});
      document.getElementById("fixedclock").textContent = "Seite geladen: " + dt + ", " + t;
    }
    showFixedClock();

    function renderDropdowns() {
      // Kategorie
      let selKat = document.getElementById("kategorie");
      selKat.innerHTML = "";
      kategorien.forEach(k => selKat.innerHTML += `<option>${k}</option>`);
      // Status
      let selStat = document.getElementById("status");
      selStat.innerHTML = "";
      stati.forEach(s => selStat.innerHTML += `<option>${s}</option>`);
    }

    function renderTabelle() {
      let tb = document.querySelector("#ideenTabelle tbody");
      tb.innerHTML = "";
      for (let idee of ideen) {
        tb.innerHTML += `<tr>
          <td>${idee.titel}</td>
          <td>${idee.kategorie || ""}</td>
          <td>${idee.status || ""}</td>
          <td>${idee.datum || ""}</td>
          <td>${idee.beschreibung}</td>
          <td><button class="btn" onclick="deleteIdee(${idee.id})">üóëÔ∏è</button></td>
        </tr>`;
      }
    }

    function addIdee() {
      let titel = document.getElementById("titel").value.trim();
      let kategorie = document.getElementById("kategorie").value;
      let datum = document.getElementById("datum").value || (new Date()).toISOString().slice(0,10);
      let status = document.getElementById("status").value;
      let beschreibung = document.getElementById("beschreibung").value.trim();
      if (!titel) { alert("Bitte Titel angeben."); return; }
      let id = (ideen.length ? Math.max(...ideen.map(i=>i.id))+1 : 1);
      ideen.push({id, titel, kategorie, datum, status, beschreibung});
      renderTabelle();
      document.getElementById("titel").value = "";
      document.getElementById("beschreibung").value = "";
      autosave();
    }

    function deleteIdee(id) {
      if (!confirm("Idee wirklich l√∂schen?")) return;
      ideen = ideen.filter(i => i.id !== id);
      renderTabelle();
      autosave();
    }

    function exportIdeen() {
      let blob = new Blob([JSON.stringify({
        ideen,
        kategorien,
        stati
      }, null, 2)], {type:"application/json"});
      let a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'ideenbank.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>document.body.removeChild(a), 400);
    }

    document.getElementById('importFile').onchange = function(e) {
      let file = e.target.files[0];
      if (!file) return;
      let reader = new FileReader();
      reader.onload = function(evt) {
        try {
          let data = JSON.parse(evt.target.result);
          if (!data.ideen || !Array.isArray(data.ideen)) throw new Error("Formatfehler: Array 'ideen' fehlt!");
          // Kategories und Status sammeln (noch nicht √ºbernehmen)
          importVorschauIdeen = data.ideen.map(idee => Object.assign({}, idee));
          showImportPreview();
        } catch (err) {
          alert("Fehler beim Importieren:\n" + err.message);
        }
      };
      reader.readAsText(file);
    };

    // --- Import-Vorschau ---
    function showImportPreview() {
      document.getElementById("importDialog").style.display = "block";
      renderImportVorschauTable();
    }
    function renderImportVorschauTable() {
      let box = document.getElementById("importTableBox");
      if (!importVorschauIdeen.length) { box.innerHTML = "<i>Keine Ideen zu importieren.</i>"; return; }
      let html = `<table class="import-vorschau-table"><thead>
        <tr><th>Titel</th><th>Kategorie</th><th>Status</th><th>Datum</th><th>Beschreibung</th><th></th></tr></thead><tbody>`;
      importVorschauIdeen.forEach((idee, idx) => {
        html += `<tr>
          <td>${idee.titel}</td>
          <td>${idee.kategorie || ""}</td>
          <td>${idee.status || ""}</td>
          <td>${idee.datum || ""}</td>
          <td>${idee.beschreibung}</td>
          <td><button class="btn" onclick="importRemove(${idx})">üóëÔ∏è</button></td>
        </tr>`;
      });
      html += "</tbody></table>";
      box.innerHTML = html;
    }
    function importRemove(idx) {
      importVorschauIdeen.splice(idx, 1);
      renderImportVorschauTable();
    }
    function closeImportDialog() {
      document.getElementById("importDialog").style.display = "none";
      importVorschauIdeen = [];
    }
    function importUebernehmen() {
      // Erg√§nze neue Kategorien und Stati
      importVorschauIdeen.forEach(idee => {
        if (idee.kategorie && !kategorien.includes(idee.kategorie)) kategorien.push(idee.kategorie);
        if (idee.status && !stati.includes(idee.status)) stati.push(idee.status);
      });
      // IDs sauber vergeben
      let nextId = ideen.length ? Math.max(...ideen.map(i=>i.id)) + 1 : 1;
      importVorschauIdeen.forEach((idee, idx) => {
        idee.id = nextId++;
        ideen.push(idee);
      });
      renderDropdowns();
      renderTabelle();
      autosave();
      closeImportDialog();
    }

    // --- Verwaltung Kategorien/Status (Dialog-Design) ---
    let currentCatStat = null; // "kategorie" oder "status"
    function showKategorieVerwaltung() {
      currentCatStat = "kategorie";
      showCatstatDialog("Kategorien", kategorien);
    }
    function showStatusVerwaltung() {
      currentCatStat = "status";
      showCatstatDialog("Status", stati);
    }
    function showCatstatDialog(title, arr) {
      document.getElementById("catstatTitle").textContent = title + " verwalten";
      let list = document.getElementById("catstatList");
      list.innerHTML = "";
      arr.forEach((val, idx) => {
        list.innerHTML += `
          <div class="catstat-row">
            <span>${val}</span>
            <button class="btn" onclick="editCatstat(${idx})" title="Umbenennen">‚úèÔ∏è</button>
            <button class="btn" onclick="deleteCatstat(${idx})" title="L√∂schen">üóëÔ∏è</button>
          </div>`;
      });
      document.getElementById("catstatInput").value = "";
      document.getElementById("catstatDialog").style.display = "block";
    }
    function catstatAdd() {
      let val = document.getElementById("catstatInput").value.trim();
      if (!val) return;
      let arr = currentCatStat === "kategorie" ? kategorien : stati;
      if (arr.includes(val)) { alert("Wert existiert schon."); return; }
      arr.push(val);
      renderDropdowns();
      showCatstatDialog(currentCatStat==="kategorie"?"Kategorien":"Status", arr);
      autosave();
    }
    function deleteCatstat(idx) {
      let arr = currentCatStat === "kategorie" ? kategorien : stati;
      if (!confirm("Wirklich l√∂schen?")) return;
      let delVal = arr[idx];
      arr.splice(idx,1);
      // Alle Ideen mit dieser Kategorie/Status ggf. updaten:
      if (currentCatStat === "kategorie") ideen.forEach(i=>{if(i.kategorie===delVal) i.kategorie="";});
      if (currentCatStat === "status") ideen.forEach(i=>{if(i.status===delVal) i.status="";});
      renderDropdowns();
      renderTabelle();
      showCatstatDialog(currentCatStat==="kategorie"?"Kategorien":"Status", arr);
      autosave();
    }
    function editCatstat(idx) {
      let arr = currentCatStat === "kategorie" ? kategorien : stati;
      let oldVal = arr[idx];
      let neu = prompt("Neuer Wert f√ºr "+oldVal+":", oldVal);
      if (!neu || neu===oldVal) return;
      if (arr.includes(neu)) { alert("Wert existiert schon."); return; }
      arr[idx]=neu;
      // Alle Ideen entsprechend umbenennen:
      if (currentCatStat==="kategorie") ideen.forEach(i=>{if(i.kategorie===oldVal) i.kategorie=neu;});
      if (currentCatStat==="status") ideen.forEach(i=>{if(i.status===oldVal) i.status=neu;});
      renderDropdowns();
      renderTabelle();
      showCatstatDialog(currentCatStat==="kategorie"?"Kategorien":"Status", arr);
      autosave();
    }
    function closeCatstat() {
      document.getElementById("catstatDialog").style.display = "none";
    }

    // --- Autosave ---
    function autosave() {
      let obj = {ideen, kategorien, stati};
      localStorage.setItem("ideenbank5GL", JSON.stringify(obj));
      document.getElementById("autosaveMsg").textContent = "Gespeichert " + (new Date()).toLocaleTimeString();
    }
    function autorestore() {
      let d = localStorage.getItem("ideenbank5GL");
      if (!d) return;
      try {
        let obj = JSON.parse(d);
        if (Array.isArray(obj.ideen)) ideen = obj.ideen;
        if (Array.isArray(obj.kategorien)) kategorien = obj.kategorien;
        if (Array.isArray(obj.stati)) stati = obj.stati;
      } catch (e) { /* ignorieren */ }
    }
    window.addEventListener("beforeunload", autosave);

    // --- Initialisierung ---
    autorestore();
    renderDropdowns();
    renderTabelle();
  </script>
</body>
</html>
